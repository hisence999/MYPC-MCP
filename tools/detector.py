"""
File Detection Tools - 文件检测工具模块

提供智能文件路径检测功能，通过多种策略识别当前活动窗口关联的文件。

使用场景：
1. 当用户提到"当前打开的文件"、"正在编辑的文件"、"窗口中的文件"等模糊描述时
2. 当 AI 需要知道用户正在查看/编辑的具体文件路径时
3. 当用户说"这个文件"、"当前文件"但没有提供具体路径时
4. 当 AI 需要读取用户正在查看的文件内容时
5. 在任何需要获取活动窗口关联文件路径的场景

支持的应用类型：
- 资源管理器：自动检测选中文件和当前路径
- 文本编辑器：记事本、VS Code、Notepad++、Sublime Text
- 办公软件：Word、Excel、PowerPoint
- 压缩软件：Bandizip、WinRAR、7-Zip
- 图片查看器：Windows 照片
- 其他：任何在窗口标题中显示文件路径的软件

检测策略（按优先级）：
0. 资源管理器特殊处理 - 检测资源管理器选中项和当前路径
A. 标题路径提取 - 从窗口标题中直接提取完整路径
B. 软件特征库 - 根据软件特征模式匹配提取路径
C. 进程句柄查询 - 通过进程打开的文件句柄查找
D. 当前目录搜索 - 在项目目录和用户目录中递归搜索（3层深度）
E. Everything 搜索 - 系统级文件搜索（需要 Everything 服务）

Author: MyPC-MCP
"""

from mcp.server.fastmcp import FastMCP
from tools.detect_active_file import detect_active_file


def register_detector_tools(mcp: FastMCP):
    """
    注册文件检测工具到 MCP 服务器

    Args:
        mcp: FastMCP 服务器实例
    """

    @mcp.tool(name="MyPC-detect_active_file")
    def detect_file() -> str:
        """
        【智能文件检测】检测当前活动窗口关联的文件路径

        ═══════════════════════════════════════════════════════════════
        🎯 使用时机（重要）
        ═══════════════════════════════════════════════════════════════

        ✅ 应该使用此工具的情况：
        1. 用户提到"当前文件"、"这个文件"、"正在编辑的文件"但没有提供具体路径
        2. 用户说"打开的文件"、"窗口中的文件"、"查看的文件"
        3. AI 需要知道用户正在查看/编辑的具体文件路径
        4. 用户提到 VS Code/记事本等软件中的"当前文档"
        5. 需要读取用户正在查看的文件内容进行分析

        ❌ 不应该使用此工具的情况：
        1. 用户已经明确提供了完整文件路径
        2. 用户说的是"我的项目"、"某个文件夹"（目录，不是具体文件）
        3. 用户提到的是系统中不存在的文件或假设性文件
        4. 用户没有打开任何包含文件的窗口

        ═══════════════════════════════════════════════════════════════
        📋 支持的应用
        ═══════════════════════════════════════════════════════════════

        • 资源管理器：自动检测选中的文件或当前路径（支持多选提示）
        • 文本编辑器：记事本、VS Code、Notepad++、Sublime Text、PyCharm
        • 办公软件：Word、Excel、PowerPoint
        • 压缩软件：Bandizip、WinRAR、7-Zip、WinZip
        • 图片查看器：Windows 照片
        • 其他：任何在窗口标题中显示文件信息的软件

        ═══════════════════════════════════════════════════════════════
        📦 返回信息
        ═══════════════════════════════════════════════════════════════

        成功时返回：
        {
            "path": "完整文件路径",
            "filename": "文件名",
            "software": "打开该文件的软件名称",
            "strategy": "使用的检测策略",
            "window_title": "窗口标题",
            "size": 文件大小（字节）,
            "modified": "最后修改时间",
            "is_text": true/false,
            "preview": "文本预览（如果是文本文件）"
        }

        资源管理器特殊返回：
        {
            "type": "directory",  // 或文件的标准返回
            "path": "路径",
            "software": "explorer.exe",
            "strategy": "资源管理器选中项" 或 "资源管理器当前路径",
            "explorer_info": {
                "current_path": "当前浏览路径",
                "selected_files": ["选中的文件1", "选中的文件2", ...]
            },
            "note": "共选中 N 个文件，返回第一个"  // 仅多选时有此字段
        }

        失败时返回：
        {
            "error": "错误信息",
            "window_title": "当前窗口标题",
            "process_name": "进程名称",
            "suggestion": "建议"
        }

        ═══════════════════════════════════════════════════════════════
        💡 提示
        ═══════════════════════════════════════════════════════════════

        此工具使用 6 种策略按优先级检测文件：
        • 策略 Explorer：资源管理器特殊处理（自动检测选中文件）
        • 策略 A：标题路径提取（最快）
        • 策略 B：软件特征库匹配
        • 策略 C：进程句柄查询
        • 策略 D：当前目录递归搜索（3层深度）
        • 策略 E：Everything 系统级搜索（终极后备）

        即使文件藏在极深的目录下，也能通过 Everything 搜索找到。
        对于资源管理器，会自动返回选中的文件；如果选中多个，返回第一个并提示。
        """
        import json
        result = detect_active_file()
        return json.dumps(result, ensure_ascii=False, indent=2)
